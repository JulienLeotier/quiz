<!-- chat/templates/chat/room.html -->
<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <title>QUIZ DISPLAY</title>
  <!--Import Google Icon Font-->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <!--Import materialize.css-->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
  <!--Let browser know website is optimized for mobile-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
</head>

<body>
  <div class="row">
    <div class="col s12">
      <ul class="tabs">
        <li class="tab col s3"><a href="#test1" class="active" id="tab2">Question</a></li>
        <li class="tab col s2"><a href="#test2" id="tab3">Audio</a></li>
        <li class="tab col s2"><a href="#test3" id="tab4">Vidéo</a></li>
        <li class="tab col s2"><a href="#test4" id="tab5">Image</a></li>
      </ul>
    </div>
      <div class="row">
        <div class="col s12 m12">
          <div class="card">
            <div class="card-content">
              <p class="card-title" id="question">En attente de question</p>
              <div class="row">
                <div class="col s12 m12">
                  <p id="a">
                  A: <button id="props1" class="waves-effect waves-light btn-large" style="width: 90%">En attente de
                    proposition A</button>
                  </p>
                </div>
              </div>
              <div class="row">
                <div class="col s12 m12">
                  <p id="b">
                  B: <button id="props2" class="waves-effect waves-light btn-large" style="width: 90%">En attente de
                    proposition B</button>
                  </p>
                </div>
              </div>
              <div class="row">
                <div class="col s12 m12">
                  <p id="c">
                  C: <button id="props3" class="waves-effect waves-light btn-large" style="width: 90%">En attente de
                    proposition C</button></p>
                </div>
              </div>
              <div class="row">
                <div class="col s12 m12">
                  <p id="d">
                  D: <button id="props4" class="waves-effect waves-light btn-large" style="width: 90%">En attente de
                    proposition D</button>
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    <div id="test1" class="col s12">
      <div class="row">
        <div class="col s12">
          <table>
            <thead>
              <tr>
                  <th>Pseudo</th>
                  <th>Score</th>
              </tr>
            </thead>
    
            <tbody>
              {% for player in players %}
              <tr>
                <td id="{{player.user}}">{{player.user}}</td>
                {% for score in scores %}
                {% if score.player == player%}
                <td id="{{player.user}}-score">{{score.score}}</td>
                {% endif %}
                {% endfor %}
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

    </div>
    <div id="test2" class="col s12">
      <div class="row">
        <div class="col s12">
          <audio id="audio" controls preload="none" style="margin-left: 33%;">
            <source id="my_audio" src="">
            Your browser does not support the audio format.
          </audio>
        </div>
      </div>

    </div>
    <div id="test3" class="col s12">
      <div class="row">
        <div class="col s12">
          <video id="video" style="margin-left: 33%;" width="320" height="240" controls></video>
        </div>
      </div>
    </div>
    <div id="test4" class="col s12">
      <div class="row">
        <div class="col s12">
          <div class="card-image">
            <img id="image1" src="" style="margin-left: 33%" alt="image">
          </div>
        </div>
      </div>
    </div>
  </div>
  {{ room_name|json_script:"room-name" }}
  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
  <script type="text/javascript" src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
  <script>
    var el = document.querySelector('.tabs');
    var instance = M.Tabs.init(el, {});
    const roomName = JSON.parse(document.getElementById('room-name').textContent);

    const chatSocket = new WebSocket(
      'ws://' +
      window.location.host +
      '/ws/' +
      roomName +
      '/'
    );

    chatSocket.onmessage = function (e) {
      const data = JSON.parse(e.data);
      if (data.type === 'reveal') {
        document.querySelector('#resp').innerHTML = 'Réponse : ' + data.message || data.message
      } 
      else if(data.type === 'score'){
        document.querySelector('#' + data.player + '-score').innerHTML = data.message
        document.querySelector('#tab1').replace("active", "");
        document.querySelector('#tab2').replace("", "active");
        document.querySelector('#tab3').replace("active", "");
        document.querySelector('#tab4').replace("active", "");
        document.querySelector('#tab5').replace("active", "");

      } else {
        document.querySelector('#props3').disabled = false
        document.querySelector('#props2').disabled = false
        document.querySelector('#props1').disabled = false
        document.querySelector('#props4').disabled = false
        document.querySelector('#question').innerHTML = data.message.question || data.message
        document.querySelector('#props1').innerHTML = data.message.propositionOne || data.message
        document.querySelector('#props2').innerHTML = data.message.propositionTwo || data.message
        if (data.message.audio !== '' && data.message.audio !== undefined) {
          var audio = document.querySelector('#audio')
          document.querySelector('#my_audio').src = '/' + data.message.audio
          audio.load()
        }
        if (data.message.image !== '' && data.message.image !== undefined) {
          var image = document.getElementById("image1");
          image.src = '/' + data.message.image
        }
        if (data.message.video !== '' && data.message.video !== undefined) {
          var video = document.getElementById('video');
          var source = document.createElement('source');
  
          source.setAttribute('src', '/' + data.message.video);
          source.setAttribute('type', 'video/webm');
          video.appendChild(source);
          video.load()
        }
        if(data.message.propositionThree !== null){
          document.querySelector('#c').style.display = 'block'
          document.querySelector('#d').style.display = 'block'
          document.querySelector('#props3').innerHTML = data.message.propositionThree || data.message
          document.querySelector('#props4').innerHTML = data.message.propositionFour || data.message
        } else {
          document.querySelector('#c').style.display = 'none'
          document.querySelector('#d').style.display = 'none'
        }
      }
    };

    chatSocket.onclose = function (e) {
      console.error('Chat socket closed unexpectedly');
    };
    document.querySelector('#props1').onclick = function (e) {
      document.querySelector('#props3').disabled = true
      document.querySelector('#props2').disabled = true
      document.querySelector('#props1').disabled = true
      document.querySelector('#props4').disabled = true
      chatSocket.send(JSON.stringify({
        'message': {
          'type': 'response',
          'question': document.querySelector('#question').innerText,
          'message': document.querySelector('#props1').innerText,
          'player': "{{user.get_username}}"
        }
      }));
    };
    document.querySelector('#props2').onclick = function (e) {
      document.querySelector('#props3').disabled = true
      document.querySelector('#props2').disabled = true
      document.querySelector('#props1').disabled = true
      document.querySelector('#props4').disabled = true
      chatSocket.send(JSON.stringify({
        'message': {
          'type': 'response',
          'question': document.querySelector('#question').innerText,
          'message': document.querySelector('#props2').innerText,
          'player': "{{user.get_username}}"
        }
      }));
    };
    document.querySelector('#props3').onclick = function (e) {
      document.querySelector('#props3').disabled = true
      document.querySelector('#props2').disabled = true
      document.querySelector('#props1').disabled = true
      document.querySelector('#props4').disabled = true

      chatSocket.send(JSON.stringify({
        'message': {
          'type': 'response',
          'question': document.querySelector('#question').innerText,
          'message': document.querySelector('#props3').innerText,
          'player': "{{user.get_username}}"

        }
      }));
    };
    document.querySelector('#props4').onclick = function (e) {
      document.querySelector('#props3').disabled = true
      document.querySelector('#props2').disabled = true
      document.querySelector('#props1').disabled = true
      document.querySelector('#props4').disabled = true
      chatSocket.send(JSON.stringify({
        'message': {
          'type': 'response',
          'question': document.querySelector('#question').innerText,
          'message': document.querySelector('#props4').innerText,
          'player': "{{user.get_username}}"
        }
      }));
    };
  </script>
</body>

</html>